# Tasks to bootstrap key-based auth over SSH for ansible on Linux devices

- name: Create default user
  ansible.builtin.user:
    name: "{{ bootstrap_user }}"
    shell: "{{ bootstrap_user_shell }}"
    state: present

- name: Deploy public key
  ansible.posix.authorized_key:
    user: ansible
    key: "{{ lookup('file', bootstrap_user_pubkey) }}"
    state: present

- name: Install sudo
  ansible.builtin.apt:
    name:
    - sudo
    state: present

- name: Add to sudoers group
  ansible.builtin.lineinfile:
    path: /etc/sudoers.d/{{ bootstrap_user }}
    line: "{{ bootstrap_user }} ALL=(ALL) NOPASSWD:ALL"
    mode: "0440"
    create: yes

- name: Require Terminal Access
  ansible.builtin.lineinfile:
    path: /etc/sudoers.d/{{ bootstrap_user }}
    line: "Defaults:{{ bootstrap_user }} !requiretty"
    mode: "0440"
    create: yes
