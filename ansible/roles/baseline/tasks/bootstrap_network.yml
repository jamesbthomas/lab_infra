# Called from the baseline role to configure the network settings on the bootstrap node

- name: Grab Interface Name
  ansible.builtin.shell: find /sys/class/net -type l -not -lname "*virtual*" -printf "%f"
  register: physical_iface_name
  changed_when: false

- name: Set Core VM Bridge
  ansible.builtin.blockinfile:
    path: /etc/network/interfaces
    backup: yes
    marker: "# {mark} ANSIBLE MANAGED: baseline > bootstrap_network > core"
    block: |
      # Core Bridge
      auto vmbr{{ core_vlan_id }}
      iface vmbr{{ core_vlan_id }} inet manual
        bridge-ports {{ physical_iface_name.stdout }}.{{ core_vlan_id }}
        bridge-stp off
        bridge-fd 0
  notify: Reload interface configurations

- name: Set Core Protected VM Bridge
  ansible.builtin.blockinfile:
    path: /etc/network/interfaces
    marker: "# {mark} ANSIBLE MANAGED: baseline > bootstrap_network > core-protected"
    block: |
      # Core Protected Bridge
      auto vmbr{{ core_protected_vlan_id }}
      iface vmbr{{ core_protected_vlan_id }} inet manual
        bridge-ports {{ physical_iface_name.stdout }}.{{ core_protected_vlan_id }}
        bridge-stp off
        bridge-fd 0
  notify: Reload interface configurations

- name: Set Management VM Bridge
  ansible.builtin.blockinfile:
    path: /etc/network/interfaces
    marker: "# {mark} ANSIBLE MANAGED: baseline > bootstrap_network > management"
    block: |
      # Management Bridge
      auto vmbr{{ mgmt_vlan_id }}
      iface vmbr{{ mgmt_vlan_id }} inet static
        address {{ mgmt_address }}
        gateway {{ mgmt_gateway }}
        bridge-ports {{ physical_iface_name.stdout }}.{{ mgmt_vlan_id }}
        bridge-stp off
        bridge-fd 0
  notify: Reload interface configurations
